# HERO 基于 Emotion-LLaMA 的实现记录

## 进度记录

### 1. 接入 AU 特征到 MER2024 数据流

- **目标**：在 `MER2024Dataset` 中读取 OpenFace AU 特征，并与 FaceMAE/VideoMAE/Audio 特征拼接，作为模型的额外模态输入。
- **改动**：
  - 支持通过配置传入 `au_feature_dir`，默认读取 `openface_au_23_UTT` 目录。
  - `get()` 中新增 AU 特征加载逻辑（如果文件不存在则保持兼容）。
  - `__getitem__` 中根据 AU 特征是否存在动态拼接。

### 2. 让模型支持 4 路特征输入

- **目标**：在 `MiniGPTv2` 中新增 AU 特征投影通道，并根据输入模态数动态处理。
- **改动**：
  - 新增 `feats_llama_proj4`。
  - `encode_img` 中根据 `video_features` 的模态数动态投影，支持 3 路或 4 路特征。

### 3. 配置项补充

- **目标**：保证训练配置里可以指定 AU 特征目录。
- **改动**：
  - `minigpt4/configs/datasets/firstface/mer2024.yaml` 增加 `au_feature_dir`。

---

后续将继续在该文档中补充每一步的实现过程。

### 4. AU 特征缺失的鲁棒性处理

- **目标**：当配置启用 AU 特征但个别样本缺失 AU 文件时，保持 batch 形状稳定并给出提示。
- **改动**：
  - 在数据集内记录 `include_au` 标记。
  - 如果 AU 文件缺失，使用与音频特征同形状的零张量作为占位，并仅提示一次 warning。

### 5. AU 特征维度对齐

- **目标**：当 AU 特征维度与音频特征维度不一致时，自动对齐，避免后续拼接报错。
- **改动**：
  - 新增 `_align_au_dim`，对 AU 特征进行截断或零填充以匹配音频特征维度。
  - 维度不一致时仅提示一次 warning。

### 6. 模态缺失鲁棒性：模态丢弃训练

- **目标**：模拟模态缺失场景，提升模型在缺失 AU/音频/视觉特征时的鲁棒性。
- **改动**：
  - 数据集新增 `modality_dropout_prob`，按概率随机屏蔽模态特征。
  - 返回 `modality_mask` 以便后续在模型或损失中使用。
